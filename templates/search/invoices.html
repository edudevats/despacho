{% extends "base.html" %}

{% block title %}Facturas y Movimientos - {{ company.name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header page-header-blue">
    <h1>
        <i class="fas fa-file-invoice"></i> Facturas y Movimientos
        <span class="badge bg-light text-primary">{{ company.name }}</span>
    </h1>
    <div class="user-info">
        Consulta, filtra y descarga facturas
    </div>
</div>

<!-- Search Form -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filtros de Búsqueda</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="/companies/{{ company.id }}/search">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="date_from" class="form-label">Fecha Desde</label>
                    <input type="date" class="form-control" id="date_from" name="date_from"
                        value="{{ filters.date_from or '' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="date_to" class="form-label">Fecha Hasta</label>
                    <input type="date" class="form-control" id="date_to" name="date_to"
                        value="{{ filters.date_to or '' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="q" class="form-label">Texto</label>
                    <input type="text" class="form-control" id="q" name="q" value="{{ filters.q or '' }}"
                        placeholder="Buscar...">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="min_amount" class="form-label">Monto Mínimo</label>
                    <input type="number" class="form-control" id="min_amount" name="min_amount"
                        value="{{ filters.min_amount or '' }}" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="max_amount" class="form-label">Monto Máximo</label>
                    <input type="number" class="form-control" id="max_amount" name="max_amount"
                        value="{{ filters.max_amount or '' }}" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="supplier_id" class="form-label">Proveedor</label>
                    <select class="form-select" id="supplier_id" name="supplier_id">
                        <option value="">Todos los proveedores</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if filters.supplier_id==supplier.id %}selected{% endif %}>
                            {{ supplier.business_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-search"></i> Buscar
                </button>
                <a href="/companies/{{ company.id }}/search" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Results -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-file-invoice"></i> Resultados ({{ invoices|length }} facturas)
        </h5>
    </div>
    <div class="card-body">
        {% if invoices %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>UUID</th>
                        <th class="text-end">Total</th>
                        <th class="text-center">Método</th>
                        <th>Tipo</th>
                        <th class="text-center">Descargas</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>{{ invoice.date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div>
                                {% if invoice.issuer_rfc == company.rfc %}
                                <strong>→ {{ invoice.receiver_name or invoice.receiver_rfc }}</strong>
                                {% else %}
                                <strong>← {{ invoice.issuer_name or invoice.issuer_rfc }}</strong>
                                {% endif %}
                            </div>
                            {% if invoice.descripcion %}
                            <small class="text-muted">{{ invoice.descripcion[:50] }}{% if invoice.descripcion|length >
                                50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td><small class="font-monospace">{{ invoice.uuid[:8] }}...</small></td>
                        <td class="text-end text-money">${{ invoice.total|format_currency }}</td>

                        <!-- PPD/PUE Method Indicator -->
                        <td class="text-center">
                            {% if invoice.metodo_pago == 'PPD' %}
                            {% if invoice.ppd_acreditado %}
                            <span class="badge bg-success"
                                title="PPD Acreditado: {{ invoice.ppd_mes_acreditado }}/{{ invoice.ppd_anio_acreditado }}">
                                <i class="fas fa-check-circle"></i> PPD
                            </span>
                            {% else %}
                            <a href="{{ url_for('ppd_list', company_id=company.id) }}?invoice_id={{ invoice.id }}"
                                class="badge bg-warning text-dark text-decoration-none"
                                title="PPD Pendiente - Click para acreditar">
                                <i class="fas fa-hourglass-half"></i> PPD
                            </a>
                            {% endif %}
                            {% else %}
                            <span class="badge bg-light text-success"
                                title="Pago en Una Exhibición - Registrado automáticamente">
                                <i class="fas fa-bolt"></i> PUE
                            </span>
                            {% endif %}
                        </td>

                        <td>
                            {# Simple rule: if company is issuer = INGRESO, otherwise = EGRESO #}
                            {% if invoice.issuer_rfc == company.rfc %}
                            <span class="movement-type movement-type-ingreso">
                                <span class="movement-indicator movement-indicator-ingreso"></span>
                                Ingreso
                            </span>
                            {% else %}
                            <span class="movement-type movement-type-egreso">
                                <span class="movement-indicator movement-indicator-egreso"></span>
                                Egreso
                            </span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <a href="{{ url_for('download_invoice_file', uuid=invoice.uuid, file_type='xml') }}"
                                class="btn btn-sm btn-outline-primary" title="Descargar XML">
                                <i class="fas fa-file-code"></i>
                            </a>
                            <a href="{{ url_for('download_invoice_file', uuid=invoice.uuid, file_type='pdf') }}"
                                class="btn btn-sm btn-outline-danger" title="Descargar PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </td>

                        <td class="text-end">
                            <a href="/companies/{{ company.id }}/invoices/{{ invoice.id }}"
                                class="btn btn-sm btn-outline-primary" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i> No se encontraron facturas con los filtros aplicados.
        </div>
        {% endif %}
    </div>
</div>

<!-- Back Button -->
<div class="mt-3">
    <a href="/search/advanced" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver a la lista de empresas
    </a>
</div>
{% endblock %}