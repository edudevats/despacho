{% extends "base.html" %}

{% block title %}{{ supplier.business_name }} - {{ company.name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header page-header-blue">
    <h1>
        <i class="fas fa-truck"></i> {{ supplier.business_name }}
        <span class="badge bg-light text-primary">{{ supplier.rfc }}</span>
    </h1>
    <div class="user-info">
        Detalle del proveedor y sus facturas
    </div>
</div>

<!-- Supplier Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Total Facturado</h6>
                <h3 class="text-primary">${{ supplier.total_invoiced|format_currency }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Facturas</h6>
                <h3 class="text-info">{{ supplier.invoice_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Primera Factura</h6>
                <h3 class="text-secondary">
                    {% if supplier.first_invoice_date %}
                    {{ supplier.first_invoice_date.strftime('%Y-%m-%d') }}
                    {% else %}
                    ---
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Última Factura</h6>
                <h3 class="text-secondary">
                    {% if supplier.last_invoice_date %}
                    {{ supplier.last_invoice_date.strftime('%Y-%m-%d') }}
                    {% else %}
                    ---
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Invoices Table -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-file-invoice"></i> Facturas ({{ invoices|length }})
        </h5>
    </div>
    <div class="card-body">
        {% if invoices %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>UUID</th>
                        <th class="text-end">Total</th>
                        <th>Tipo</th>
                        <th class="text-center">Descargas</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>{{ invoice.date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div>
                                {% if invoice.issuer_rfc == company.rfc %}
                                <strong>→ {{ invoice.receiver_name or invoice.receiver_rfc }}</strong>
                                {% else %}
                                <strong>← {{ invoice.issuer_name or invoice.issuer_rfc }}</strong>
                                {% endif %}
                            </div>
                            {% if invoice.descripcion %}
                            <small class="text-muted">{{ invoice.descripcion[:50] }}{% if invoice.descripcion|length >
                                50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td><small class="font-monospace">{{ invoice.uuid[:8] }}...</small></td>
                        <td class="text-end text-money">${{ invoice.total|format_currency }}</td>
                        <td>
                            {# Simple rule: if company is issuer = INGRESO, otherwise = EGRESO #}
                            {% if invoice.issuer_rfc == company.rfc %}
                            <span class="movement-type movement-type-ingreso">
                                <span class="movement-indicator movement-indicator-ingreso"></span>
                                Ingreso
                            </span>
                            {% else %}
                            <span class="movement-type movement-type-egreso">
                                <span class="movement-indicator movement-indicator-egreso"></span>
                                Egreso
                            </span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <a href="{{ url_for('download_invoice_file', uuid=invoice.uuid, file_type='xml') }}"
                                class="btn btn-sm btn-outline-primary" title="Descargar XML">
                                <i class="fas fa-file-code"></i>
                            </a>
                            <a href="{{ url_for('download_invoice_file', uuid=invoice.uuid, file_type='pdf') }}"
                                class="btn btn-sm btn-outline-danger" title="Descargar PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </td>

                        <td class="text-end">
                            <a href="/companies/{{ company.id }}/invoices/{{ invoice.id }}"
                                class="btn btn-sm btn-outline-primary" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i> No se encontraron facturas para este proveedor.
        </div>
        {% endif %}
    </div>
</div>

<!-- Back Button -->
<div class="mt-3">
    <a href="/companies/{{ company.id }}/suppliers" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver a Proveedores
    </a>
</div>
{% endblock %}