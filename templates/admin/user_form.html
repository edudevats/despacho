{% extends "base.html" %}

{% block title %}{{ 'Nuevo' if action == 'crear' else 'Editar' }} Usuario{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-user-{{ 'plus' if action == 'crear' else 'edit' }} text-primary"></i>
                {{ 'Nuevo Usuario' if action == 'crear' else 'Editar Usuario' }}
            </h2>
        </div>
    </div>

    <form method="POST">
        {{ form.hidden_tag() }}

        <div class="row">
            <!-- Datos del Usuario -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Datos del Usuario</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.username.label(class="form-label") }}
                            {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                            {% if form.username.errors %}
                            <div class="invalid-feedback">{{ form.username.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                            {% if form.email.errors %}
                            <div class="invalid-feedback">{{ form.email.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.password.label(class="form-label") }}
                            {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), autocomplete="new-password") }}
                            {% if form.password.errors %}
                            <div class="invalid-feedback">{{ form.password.errors[0] }}</div>
                            {% endif %}
                            {% if action == 'editar' %}
                            <small class="text-muted">Dejar vacio para mantener la contrasena actual</small>
                            {% else %}
                            <small class="text-muted">Si no se especifica, sera "changeme"</small>
                            {% endif %}
                        </div>

                        <hr>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.is_active(class="form-check-input") }}
                                {{ form.is_active.label(class="form-check-label") }}
                            </div>
                            <small class="text-muted">Los usuarios inactivos no pueden iniciar sesion</small>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.is_admin(class="form-check-input", id="isAdminSwitch") }}
                                {{ form.is_admin.label(class="form-check-label") }}
                            </div>
                            <small class="text-muted">Los administradores tienen acceso total a todas las empresas y funciones</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acceso a Empresas -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4" id="companyAccessCard">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-building"></i> Acceso a Empresas</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" id="adminAlert" style="display: none;">
                            <i class="fas fa-info-circle"></i> Los administradores tienen acceso automatico a todas las empresas con todos los permisos.
                        </div>

                        <div id="companyPermissions">
                            {% if companies %}
                            {% for company in companies %}
                            {% set access = user_access.get(company.id) if user_access is defined else None %}
                            <div class="card mb-3 company-card">
                                <div class="card-header py-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input company-checkbox"
                                               name="company_{{ company.id }}" id="company_{{ company.id }}"
                                               {{ 'checked' if access else '' }}
                                               onchange="toggleCompanyPermissions({{ company.id }})">
                                        <label class="form-check-label fw-bold" for="company_{{ company.id }}">
                                            {{ company.name }}
                                        </label>
                                        <small class="text-muted ms-2">{{ company.rfc }}</small>
                                    </div>
                                </div>
                                <div class="card-body py-2 company-permissions" id="permissions_{{ company.id }}"
                                     style="{{ '' if access else 'display: none;' }}">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_dashboard_{{ company.id }}"
                                                       id="perm_dashboard_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_dashboard else 'checked' if not access else '' }}>
                                                <label class="form-check-label" for="perm_dashboard_{{ company.id }}">
                                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_sync_{{ company.id }}"
                                                       id="perm_sync_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_sync else '' }}>
                                                <label class="form-check-label" for="perm_sync_{{ company.id }}">
                                                    <i class="fas fa-sync"></i> Sincronizacion
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_inventory_{{ company.id }}"
                                                       id="perm_inventory_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_inventory else '' }}>
                                                <label class="form-check-label" for="perm_inventory_{{ company.id }}">
                                                    <i class="fas fa-boxes"></i> Inventario
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_invoices_{{ company.id }}"
                                                       id="perm_invoices_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_invoices else '' }}>
                                                <label class="form-check-label" for="perm_invoices_{{ company.id }}">
                                                    <i class="fas fa-file-invoice"></i> Facturas
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_ppd_{{ company.id }}"
                                                       id="perm_ppd_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_ppd else '' }}>
                                                <label class="form-check-label" for="perm_ppd_{{ company.id }}">
                                                    <i class="fas fa-file-invoice-dollar"></i> Facturas PPD
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_taxes_{{ company.id }}"
                                                       id="perm_taxes_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_taxes else '' }}>
                                                <label class="form-check-label" for="perm_taxes_{{ company.id }}">
                                                    <i class="fas fa-calculator"></i> Impuestos
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_sales_{{ company.id }}"
                                                       id="perm_sales_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_sales else '' }}>
                                                <label class="form-check-label" for="perm_sales_{{ company.id }}">
                                                    <i class="fas fa-chart-line"></i> Ventas
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="perm_facturacion_{{ company.id }}"
                                                       id="perm_facturacion_{{ company.id }}"
                                                       {{ 'checked' if access and access.perm_facturacion else '' }}>
                                                <label class="form-check-label" for="perm_facturacion_{{ company.id }}">
                                                    <i class="fas fa-receipt"></i> Facturacion
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="selectAllPermissions({{ company.id }})">
                                            <i class="fas fa-check-double"></i> Todos
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllPermissions({{ company.id }})">
                                            <i class="fas fa-times"></i> Ninguno
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> No hay empresas registradas.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> {{ 'Crear Usuario' if action == 'crear' else 'Guardar Cambios' }}
            </button>
        </div>
    </form>
</div>

<script>
function toggleCompanyPermissions(companyId) {
    const checkbox = document.getElementById('company_' + companyId);
    const permissions = document.getElementById('permissions_' + companyId);
    if (checkbox.checked) {
        permissions.style.display = 'block';
        // Auto-check dashboard when company is selected
        document.getElementById('perm_dashboard_' + companyId).checked = true;
    } else {
        permissions.style.display = 'none';
    }
}

function selectAllPermissions(companyId) {
    const permissions = document.getElementById('permissions_' + companyId);
    permissions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function clearAllPermissions(companyId) {
    const permissions = document.getElementById('permissions_' + companyId);
    permissions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function toggleAdminMode() {
    const isAdmin = document.getElementById('isAdminSwitch').checked;
    const companyCards = document.querySelectorAll('.company-card');
    const adminAlert = document.getElementById('adminAlert');

    if (isAdmin) {
        adminAlert.style.display = 'block';
        companyCards.forEach(card => card.style.opacity = '0.5');
    } else {
        adminAlert.style.display = 'none';
        companyCards.forEach(card => card.style.opacity = '1');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('isAdminSwitch').addEventListener('change', toggleAdminMode);
    toggleAdminMode(); // Check initial state
});
</script>
{% endblock %}
