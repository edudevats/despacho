{% extends "base.html" %}

{% block title %}Inventario - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-warehouse text-primary"></i> Inventario: {{ company.name }}</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('company_dashboard', company_id=company.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="inventoryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'products' else '' }}" id="products-tab"
                    data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                <i class="fas fa-pills"></i> Medicamentos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'laboratories' else '' }}" id="laboratories-tab"
                    data-bs-toggle="tab" data-bs-target="#laboratories" type="button" role="tab">
                <i class="fas fa-flask"></i> Laboratorios
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'suppliers' else '' }}" id="suppliers-tab"
                    data-bs-toggle="tab" data-bs-target="#suppliers" type="button" role="tab">
                <i class="fas fa-truck"></i> Proveedores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'orders' else '' }}" id="orders-tab"
                    data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                <i class="fas fa-clipboard-list"></i> Ordenes de Compra
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'services' else '' }}" id="services-tab"
                    data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">
                <i class="fas fa-stethoscope"></i> Servicios
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'templates' else '' }}" id="templates-tab"
                    data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                <i class="fas fa-file-medical"></i> Plantillas
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="inventoryTabContent">
        <!-- TAB: Medicamentos/Productos -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'products' else '' }}" id="products" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Medicamentos / Productos</h4>
                <a href="{{ url_for('add_product', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </a>
            </div>

            <!-- Resumen -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-0">Valor Total Inventario (Costo)</h6>
                                <h3 class="text-primary mb-0">${{ total_inventory_value|format_currency }}</h3>
                            </div>
                            <div>
                                <h6 class="text-muted mb-0">Total Items</h6>
                                <h3 class="mb-0">{{ total_items }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Productos -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Laboratorio</th>
                                    <th class="text-end">Costo</th>
                                    <th class="text-end">Margen</th>
                                    <th class="text-end">Precio Venta</th>
                                    <th class="text-center">Stock</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr {% if product.current_stock <= product.min_stock_level %}class="table-warning border-start border-warning border-4"{% endif %}>
                                    <td><small class="text-muted">{{ product.sku or '--' }}</small></td>
                                    <td>
                                        <strong>{{ product.name }}</strong>
                                        {% if product.is_controlled %}
                                        <span class="badge bg-danger ms-1" title="Medicamento Controlado">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                        {% endif %}
                                        {% if product.description %}
                                        <br><small class="text-muted">{{ product.description|truncate(40) }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if product.laboratory %}
                                        <small>{{ product.laboratory.name }}</small>
                                        {% else %}
                                        <small class="text-muted">--</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end text-muted">${{ product.cost_price|format_currency }}</td>
                                    <td class="text-end">
                                        {% if product.profit_margin %}
                                        <span class="badge bg-info">{{ product.profit_margin }}%</span>
                                        {% else %}
                                        <small class="text-muted">--</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end text-success fw-bold">${{ product.calculated_selling_price|format_currency }}</td>
                                    <td class="text-center">
                                        <span class="badge {% if product.current_stock <= product.min_stock_level %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-pill">
                                            {{ product.current_stock }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('adjust_stock', company_id=company.id, product_id=product.id) }}"
                                                class="btn btn-outline-primary" title="Ajustar Stock">
                                                <i class="fas fa-boxes"></i>
                                            </a>
                                            <a href="{{ url_for('edit_product', company_id=company.id, product_id=product.id) }}"
                                                class="btn btn-outline-secondary" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        <i class="fas fa-box-open fa-3x mb-3"></i><br>
                                        No hay productos registrados.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Laboratorios -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'laboratories' else '' }}" id="laboratories" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Laboratorios</h4>
                <a href="{{ url_for('add_laboratory', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nuevo Laboratorio
                </a>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Registro Sanitario</th>
                                    <th class="text-center">Productos</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lab in laboratories %}
                                <tr>
                                    <td><strong>{{ lab.name }}</strong></td>
                                    <td>{{ lab.sanitary_registration or '--' }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary rounded-pill">{{ lab.products|length }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% if lab.active %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_laboratory', company_id=company.id, laboratory_id=lab.id) }}"
                                            class="btn btn-sm btn-outline-secondary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="fas fa-flask fa-3x mb-3"></i><br>
                                        No hay laboratorios registrados.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Proveedores -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'suppliers' else '' }}" id="suppliers" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Proveedores</h4>
                <a href="{{ url_for('add_supplier_manual', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nuevo Proveedor
                </a>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>RFC</th>
                                    <th>Razon Social</th>
                                    <th>Contacto</th>
                                    <th>Telefono</th>
                                    <th>Condiciones</th>
                                    <th class="text-center">Tipo</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for supplier in suppliers %}
                                <tr>
                                    <td><code>{{ supplier.rfc }}</code></td>
                                    <td>
                                        <strong>{{ supplier.business_name }}</strong>
                                        {% if supplier.commercial_name %}
                                        <br><small class="text-muted">{{ supplier.commercial_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ supplier.contact_name or '--' }}</td>
                                    <td>{{ supplier.phone or '--' }}</td>
                                    <td>{{ supplier.payment_terms or '--' }}</td>
                                    <td class="text-center">
                                        {% if supplier.is_medication_supplier %}
                                        <span class="badge bg-success">Medicamentos</span>
                                        {% else %}
                                        <span class="badge bg-secondary">General</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_supplier_inventory', company_id=company.id, supplier_id=supplier.id) }}"
                                            class="btn btn-sm btn-outline-secondary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="fas fa-truck fa-3x mb-3"></i><br>
                                        No hay proveedores registrados.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Ordenes de Compra -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'orders' else '' }}" id="orders" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Ordenes de Compra</h4>
                <a href="{{ url_for('add_purchase_order', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nueva Orden
                </a>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th># Orden</th>
                                    <th>Proveedor</th>
                                    <th>Fecha</th>
                                    <th class="text-end">Total Est.</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in purchase_orders %}
                                <tr>
                                    <td><strong>#{{ order.id }}</strong></td>
                                    <td>{{ order.supplier.business_name }}</td>
                                    <td>{{ order.created_at.strftime('%d/%m/%Y') }}</td>
                                    <td class="text-end">${{ order.estimated_total|format_currency }}</td>
                                    <td class="text-center">
                                        {% if order.status == 'DRAFT' %}
                                        <span class="badge bg-secondary">Borrador</span>
                                        {% elif order.status == 'SENT' %}
                                        <span class="badge bg-info">Enviada</span>
                                        {% elif order.status == 'IN_REVIEW' %}
                                        <span class="badge bg-warning text-dark">En Revision</span>
                                        {% elif order.status == 'COMPLETED' %}
                                        <span class="badge bg-success">Completada</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if order.status == 'DRAFT' or order.status == 'SENT' %}
                                        <a href="{{ url_for('edit_purchase_order', company_id=company.id, order_id=order.id) }}"
                                            class="btn btn-sm btn-outline-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        {% if order.status == 'SENT' %}
                                        <a href="{{ url_for('review_purchase_order', company_id=company.id, order_id=order.id) }}"
                                            class="btn btn-sm btn-warning" title="Revisar Recepcion">
                                            <i class="fas fa-clipboard-check"></i>
                                        </a>
                                        {% endif %}
                                        {% if order.status == 'IN_REVIEW' %}
                                        <a href="{{ url_for('complete_purchase_order', company_id=company.id, order_id=order.id) }}"
                                            class="btn btn-sm btn-success" title="Completar">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('view_purchase_order', company_id=company.id, order_id=order.id) }}"
                                            class="btn btn-sm btn-outline-secondary" title="Ver Detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar"
                                            onclick="confirmDeleteOrder('{{ order.id }}', '{{ order.supplier.business_name }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="fas fa-clipboard-list fa-3x mb-3"></i><br>
                                        No hay ordenes de compra.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Servicios -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'services' else '' }}" id="services" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Servicios Medicos</h4>
                <a href="{{ url_for('add_service', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nuevo Servicio
                </a>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripcion</th>
                                    <th class="text-end">Precio</th>
                                    <th>Clave SAT</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in services %}
                                <tr>
                                    <td><strong>{{ service.name }}</strong></td>
                                    <td>{{ service.description|truncate(50) if service.description else '--' }}</td>
                                    <td class="text-end text-success fw-bold">${{ service.price|format_currency }}</td>
                                    <td><code>{{ service.sat_key }}</code></td>
                                    <td class="text-center">
                                        {% if service.active %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_service', company_id=company.id, service_id=service.id) }}"
                                            class="btn btn-sm btn-outline-secondary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="fas fa-stethoscope fa-3x mb-3"></i><br>
                                        No hay servicios registrados.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Plantillas -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'templates' else '' }}" id="templates" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Plantillas de Factura</h4>
                <a href="{{ url_for('add_invoice_template', company_id=company.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nueva Plantilla
                </a>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripcion</th>
                                    <th class="text-center">Items</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for template in invoice_templates %}
                                <tr>
                                    <td><strong>{{ template.name }}</strong></td>
                                    <td>{{ template.description|truncate(50) if template.description else '--' }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary rounded-pill">{{ template.items|length }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% if template.active %}
                                        <span class="badge bg-success">Activa</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactiva</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_invoice_template', company_id=company.id, template_id=template.id) }}"
                                            class="btn btn-sm btn-outline-secondary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('crear_factura', company_id=company.id, template_id=template.id) }}"
                                            class="btn btn-sm btn-success" title="Usar para Facturar">
                                            <i class="fas fa-file-invoice-dollar"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="fas fa-file-medical fa-3x mb-3"></i><br>
                                        No hay plantillas registradas.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Orden -->
<div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro que deseas eliminar la orden de compra del proveedor <strong id="deleteOrderSupplier"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle"></i> Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteOrderForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Confirm delete order
function confirmDeleteOrder(orderId, supplierName) {
    document.getElementById('deleteOrderSupplier').textContent = supplierName;
    document.getElementById('deleteOrderForm').action = "{{ url_for('delete_purchase_order', company_id=company.id, order_id=0) }}".replace('/0', '/' + orderId);
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
    deleteModal.show();
}

// Maintain tab state via URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');

    if (tab) {
        const tabButton = document.querySelector(`#${tab}-tab`);
        if (tabButton) {
            new bootstrap.Tab(tabButton).show();
        }
    }

    // Update URL when tab changes
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
        button.addEventListener('shown.bs.tab', function(e) {
            const tabId = e.target.getAttribute('data-bs-target').replace('#', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.replaceState({}, '', url);
        });
    });
});
</script>
{% endblock %}
