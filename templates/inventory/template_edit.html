{% extends "base.html" %}

{% block title %}Editar Plantilla - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-file-medical text-primary"></i>
                Plantilla: {{ template.name }}
            </h2>
            <p class="text-muted">{{ template.description or 'Sin descripcion' }}</p>
        </div>
        <div class="col-md-4 text-end">
            {% if template.active %}
            <span class="badge bg-success fs-6">Activa</span>
            {% else %}
            <span class="badge bg-danger fs-6">Inactiva</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Items de la Plantilla -->
        <div class="col-lg-8">
            <!-- Informacion Basica -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informacion</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="update_info">
                        {{ form.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.name.label(class="form-label") }}
                                {{ form.name(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.description.label(class="form-label") }}
                                {{ form.description(class="form-control") }}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-save"></i> Guardar Informacion
                        </button>
                    </form>
                </div>
            </div>

            <!-- Lista de Items -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Items de la Plantilla</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nombre</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total = namespace(value=0) %}
                                {% for item in template.items %}
                                {% set subtotal = item.quantity * item.item_price %}
                                {% set total.value = total.value + subtotal %}
                                <tr>
                                    <td>
                                        {% if item.item_type == 'PRODUCT' %}
                                        <span class="badge bg-primary"><i class="fas fa-pills"></i> Producto</span>
                                        {% else %}
                                        <span class="badge bg-info"><i class="fas fa-stethoscope"></i> Servicio</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ item.item_name }}</strong></td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end">${{ item.item_price|format_currency }}</td>
                                    <td class="text-end fw-bold">${{ subtotal|format_currency }}</td>
                                    <td class="text-center">
                                        <form method="POST" style="display: inline;">
                                            <input type="hidden" name="action" value="remove_item">
                                            <input type="hidden" name="item_id" value="{{ item.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No hay items agregados.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% if template.items %}
                            <tfoot class="table-light">
                                <tr class="fw-bold">
                                    <td colspan="4" class="text-end">Total Estimado:</td>
                                    <td class="text-end text-success">${{ total.value|format_currency }}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('inventory_list', company_id=company.id, tab='templates') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                {% if template.items %}
                <a href="{{ url_for('crear_factura', company_id=company.id, template_id=template.id) }}" class="btn btn-success">
                    <i class="fas fa-file-invoice-dollar"></i> Usar para Facturar
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Agregar Items -->
        <div class="col-lg-4">
            <!-- Agregar Producto -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-pills"></i> Agregar Producto</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="add_product">

                        <div class="mb-3">
                            <label class="form-label">Producto</label>
                            <select name="product_id" class="form-select" required>
                                <option value="">-- Seleccionar --</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">
                                    {{ product.name }} - ${{ product.calculated_selling_price|format_currency }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" name="quantity" class="form-control" value="1" min="0.01" step="0.01" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </form>
                </div>
            </div>

            <!-- Agregar Servicio -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-stethoscope"></i> Agregar Servicio</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="add_service">

                        <div class="mb-3">
                            <label class="form-label">Servicio</label>
                            <select name="service_id" class="form-select" required>
                                <option value="">-- Seleccionar --</option>
                                {% for service in services %}
                                <option value="{{ service.id }}">
                                    {{ service.name }} - ${{ service.price|format_currency }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" name="quantity" class="form-control" value="1" min="0.01" step="0.01" required>
                        </div>

                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-plus"></i> Agregar Servicio
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
