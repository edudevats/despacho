{% extends "base.html" %}

{% block title %}Registro de Movimiento - Contaduria{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header page-header-green">
    <h1><i class="fas fa-cash-register"></i> Registro de Movimiento</h1>
    <div class="user-info">Usuario: {{ current_user.nombre_completo or current_user.username }}</div>
</div>

<!-- Tabs de Ingreso/Egreso con nuevo diseno -->
<div class="movement-tabs">
    <a href="?tipo=ingreso" class="movement-tab movement-tab-ingreso {% if request.args.get('tipo', 'ingreso') == 'ingreso' %}active{% endif %}">
        <i class="fas fa-circle"></i> Ingreso
    </a>
    <a href="?tipo=egreso" class="movement-tab movement-tab-egreso {% if request.args.get('tipo') == 'egreso' %}active{% endif %}">
        <i class="fas fa-circle"></i> Egreso
    </a>
</div>

<!-- Formulario -->
<div class="form-section">
    <h3>Nuevo Movimiento Contable</h3>

    {% if request.args.get('tipo', 'ingreso') == 'ingreso' %}
    <!-- Formulario de Ingreso -->
    <form method="POST" action="{{ url_for('movimientos.registro') }}?tipo=ingreso">
        {{ ingreso_form.hidden_tag() }}
        <input type="hidden" name="tipo" value="ingreso">

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha</label>
                {{ ingreso_form.fecha(class="form-control") }}
                {% if ingreso_form.fecha.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in ingreso_form.fecha.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Monto</label>
                <div class="input-group">
                    <span class="input-group-text"><strong>$</strong></span>
                    {{ ingreso_form.monto(class="form-control", placeholder="0.00") }}
                </div>
                {% if ingreso_form.monto.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in ingreso_form.monto.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Categoria</label>
                {{ ingreso_form.categoria_id(class="form-select") }}
                {% if ingreso_form.categoria_id.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in ingreso_form.categoria_id.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Metodo de Pago</label>
                {{ ingreso_form.metodo_pago(class="form-select") }}
                {% if ingreso_form.metodo_pago.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in ingreso_form.metodo_pago.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label">Descripcion</label>
            {{ ingreso_form.notas(class="form-control", rows="3", placeholder="Ingrese una descripcion opcional...") }}
            {% if ingreso_form.notas.errors %}
                <div class="text-danger small mt-1">
                    {% for error in ingreso_form.notas.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-lg">
                Cancelar
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Guardar
            </button>
        </div>
    </form>

    {% else %}
    <!-- Formulario de Egreso -->
    <form method="POST" action="{{ url_for('movimientos.registro') }}?tipo=egreso" enctype="multipart/form-data">
        {{ egreso_form.hidden_tag() }}
        <input type="hidden" name="tipo" value="egreso">

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha</label>
                {{ egreso_form.fecha(class="form-control") }}
                {% if egreso_form.fecha.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in egreso_form.fecha.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Monto</label>
                <div class="input-group">
                    <span class="input-group-text"><strong>$</strong></span>
                    {{ egreso_form.monto(class="form-control", placeholder="0.00") }}
                </div>
                {% if egreso_form.monto.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in egreso_form.monto.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Categoria</label>
                {{ egreso_form.categoria_id(class="form-select") }}
                {% if egreso_form.categoria_id.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in egreso_form.categoria_id.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Metodo de Pago</label>
                {{ egreso_form.metodo_pago(class="form-select") }}
                {% if egreso_form.metodo_pago.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in egreso_form.metodo_pago.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripcion</label>
            {{ egreso_form.notas(class="form-control", rows="3", placeholder="Ingrese una descripcion opcional...") }}
            {% if egreso_form.notas.errors %}
                <div class="text-danger small mt-1">
                    {% for error in egreso_form.notas.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label class="form-label">Comprobante</label>
            <div class="file-upload-btn" onclick="document.getElementById('comprobante-input').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <span id="file-name">Adjuntar archivo</span>
            </div>
            {{ egreso_form.comprobante(class="d-none", id="comprobante-input") }}
            <small class="text-muted d-block mt-2">
                <i class="fas fa-info-circle"></i> El comprobante puede ser imagen (JPG, PNG) o PDF
            </small>
            {% if egreso_form.comprobante.errors %}
                <div class="text-danger small mt-1">
                    {% for error in egreso_form.comprobante.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-lg">
                Cancelar
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Guardar
            </button>
        </div>
    </form>
    {% endif %}

    <div class="text-center mt-4">
        <small class="text-muted">* Todos los campos marcados son obligatorios</small>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Actualizar nombre del archivo cuando se selecciona
document.getElementById('comprobante-input').addEventListener('change', function(e) {
    const fileName = e.target.files[0] ? e.target.files[0].name : 'Adjuntar archivo';
    document.getElementById('file-name').textContent = fileName;
});
</script>
{% endblock %}
