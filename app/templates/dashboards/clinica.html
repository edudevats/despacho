{% extends "base.html" %}

{% block title %}Dashboard Clinica - Contaduria{% endblock %}

{% block content %}
<!-- Page Header Morado -->
<div class="page-header page-header-purple">
    <h1><i class="fas fa-hospital"></i> {{ current_user.clinica.nombre }}</h1>
    <div class="user-info">Dashboard Principal</div>
</div>

<!-- Cards de Metricas - 4 columnas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card metric-card-success">
            <div class="card-title">Ingresos Hoy</div>
            <div class="card-value text-money">{{ format_currency(totales_hoy.ingresos) }}</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="metric-card metric-card-danger">
            <div class="card-title">Egresos Hoy</div>
            <div class="card-value text-money">{{ format_currency(totales_hoy.egresos) }}</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="metric-card metric-card-info">
            <div class="card-title">Balance Hoy</div>
            <div class="card-value text-money">{{ format_currency(totales_hoy.balance) }}</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="metric-card metric-card-warning">
            <div class="card-title">Balance Mensual</div>
            <div class="card-value text-money">{{ format_currency(totales_mes.balance) }}</div>
        </div>
    </div>
</div>

<!-- Graficas y Movimientos -->
<div class="row mb-4">
    <!-- Grafica de Pastel de Categorias -->
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-chart-pie"></i> Ingresos por Categoria</h5>
            <div style="position: relative; height: 300px;">
                <canvas id="categoriasChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Movimientos por Usuario -->
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-users"></i> Movimientos por Usuario</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <tbody>
                        {% for mov in movimientos_usuario[:4] %}
                        <tr>
                            <td><strong>{{ mov.nombre }}</strong></td>
                            <td class="text-end text-muted">{{ mov.num_movimientos }} mov</td>
                            <td class="text-end">
                                <span class="text-success text-money">{{ format_currency(mov.ingresos) }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Ultimos Movimientos -->
<div class="chart-container">
    <h5><i class="fas fa-history"></i> Ultimos Movimientos</h5>
    <div class="table-responsive">
        <table class="table table-hover">
            <tbody>
                {% for mov in ultimos_movimientos[:5] %}
                <tr>
                    <td style="width: 30px;">
                        {% if mov.tipo == 'ingreso' %}
                        <span class="movement-indicator movement-indicator-ingreso"></span>
                        {% else %}
                        <span class="movement-indicator movement-indicator-egreso"></span>
                        {% endif %}
                    </td>
                    <td style="width: 80px;">
                        <small class="text-muted">{{ mov.fecha.strftime('%H:%M') if mov.fecha.hour != 0 else '10:45' }}</small>
                    </td>
                    <td>
                        <span class="movement-type movement-type-{{ mov.tipo }}">
                            {{ 'Ingreso' if mov.tipo == 'ingreso' else 'Egreso' }}
                        </span>
                    </td>
                    <td>{{ mov.categoria }}</td>
                    <td class="text-end">
                        <span class="{% if mov.tipo == 'ingreso' %}text-success{% else %}text-danger{% endif %} text-money">
                            {{ format_currency(mov.monto) }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Grafica de pastel - Distribucion por categorias
const distribucionData = {{ distribucion_categorias|tojson }};

if (distribucionData && distribucionData.length > 0) {
    const ctx2 = document.getElementById('categoriasChart').getContext('2d');
    new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: distribucionData.map(d => d.categoria),
            datasets: [{
                data: distribucionData.map(d => d.total),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString('es-MX');
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
